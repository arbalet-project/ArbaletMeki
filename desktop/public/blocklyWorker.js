importScripts('charMap.js');

let nbRows;
let nbColumns;
let gridState = [];

let sharedBuffer;
let sharedArray;
let scripts;

onmessage = function (e) {

    switch (e.data.message) {
        case 'gridLength':
            nbRows = e.data.nbRows;
            nbColumns = e.data.nbColumns;
            for (let i = 0; i < nbRows; i++) {
                gridState[i] = [];
            }
            break;

        case 'sharedBuffer':
            sharedBuffer = e.data.buffer;
            sharedArray = new Int32Array(sharedBuffer);
            break;

        case 'scripts':
            scripts = e.data.scripts;
            break;    

        case 'run':
            try {
                eval(scripts['main']);
            } catch (error) {
                console.error(error);
            } finally {
                self.postMessage({
                    message: "close"
                });
                close();
            }
            break;

    }
}

// Functions used by the Javascript code generated by Blockly
function setPixel(rowX, columnY, color) {
    if ((rowX >= 0 && rowX < nbRows) && (columnY >= 0 && columnY < nbColumns)) {
        self.postMessage({
            rowX: rowX,
            columnY: columnY,
            color: color
        });
        gridState[rowX][columnY] = color;
    }
}

function switchOffPixel(rowX, columnY) {
    setPixel(rowX, columnY, '#000000');
}

function switchOffAllPixels() {
    for (let i = 0; i < nbRows; i++) {
        for (let j = 0; j < nbColumns; j++) {
            switchOffPixel(i, j);
        }
    }
}

function setAllPixels(color) {
    for (let i = 0; i < nbRows; i++) {
        for (let j = 0; j < nbColumns; j++) {
            setPixel(i, j, color);
        }
    }
}

function getPixelColor(row, column) {
    return gridState[row][column];
}

function drawLetter(inputLetter, rowX, columnY, color) {
    let letter = inputLetter.charAt(0);
    if (charMap.has(letter)) {
        let letterPixels = charMap.get(letter);
        for (let i = 0; i < letterPixels.length; i = i + 2) {
            setPixel(rowX + letterPixels[i], columnY + letterPixels[i + 1], color);
        }

    }
}

function catchEvent() {
    let eventCatched = Atomics.load(sharedArray,0);
    if(eventCatched != 0){
        Atomics.store(sharedArray,0,0);
        switch(eventCatched){
            case 1: //up
                eval(scripts["up"]);
                break;
            case 2: //right
                eval(scripts["right"]);
                break;
            case 3: //down
                eval(scripts["down"]);
                break;
            case 4:
                eval(scripts["left"]);
        }
    }
}

function sleep(time, unit) {
    if (unit === 's') {
        time = time * 1000;
    }
    var start = new Date().getTime();
    for (var i = 0; i < 1e7; i++) {
        if ((new Date().getTime() - start) > time) {
            break;
        }
    }
}

// Rewriting of the colours functions to work with events
function colourRandom() {
    var num = Math.floor(Math.random() * Math.pow(2, 24));
    return '#' + ('00000' + num.toString(16)).substr(-6);
  }
  
  function colourRgb(r, g, b) {
    r = Math.max(Math.min(Number(r), 100), 0) * 2.55;
    g = Math.max(Math.min(Number(g), 100), 0) * 2.55;
    b = Math.max(Math.min(Number(b), 100), 0) * 2.55;
    r = ('0' + (Math.round(r) || 0).toString(16)).slice(-2);
    g = ('0' + (Math.round(g) || 0).toString(16)).slice(-2);
    b = ('0' + (Math.round(b) || 0).toString(16)).slice(-2);
    return '#' + r + g + b;
  }
  
  function colourBlend(c1, c2, ratio) {
    ratio = Math.max(Math.min(Number(ratio), 1), 0);
    var r1 = parseInt(c1.substring(1, 3), 16);
    var g1 = parseInt(c1.substring(3, 5), 16);
    var b1 = parseInt(c1.substring(5, 7), 16);
    var r2 = parseInt(c2.substring(1, 3), 16);
    var g2 = parseInt(c2.substring(3, 5), 16);
    var b2 = parseInt(c2.substring(5, 7), 16);
    var r = Math.round(r1 * (1 - ratio) + r2 * ratio);
    var g = Math.round(g1 * (1 - ratio) + g2 * ratio);
    var b = Math.round(b1 * (1 - ratio) + b2 * ratio);
    r = ('0' + (r || 0).toString(16)).slice(-2);
    g = ('0' + (g || 0).toString(16)).slice(-2);
    b = ('0' + (b || 0).toString(16)).slice(-2);
    return '#' + r + g + b;
  }